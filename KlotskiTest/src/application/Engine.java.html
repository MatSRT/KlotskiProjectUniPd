<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>Engine.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">SupportTest (3) (4 set 2023 18:50:32)</a> &gt; <a href="../../index.html" class="el_group">KlotskiTest</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">application</a> &gt; <span class="el_source">Engine.java</span></div><h1>Engine.java</h1><pre class="source lang-java linenums">package application;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.Map;
import java.util.Stack;

import com.google.gson.GsonBuilder;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.Gson;

import javafx.scene.Node;
import javafx.scene.control.Alert;
import javafx.scene.control.Alert.AlertType;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyEvent;
import javafx.scene.layout.GridPane;
import javafx.scene.shape.Rectangle;


/*
	Engine of the project. 
	Class used to move pieces, reset the board, roll back last move until the start of the game, save/load the game and select a configuration
*/

public class Engine {
	
	private boolean legal;
    
<span class="nc" id="L33">    public Engine(boolean legal) {</span>
<span class="nc" id="L34">        this.legal = legal;</span>
<span class="nc" id="L35">    }</span>
    
    public boolean isLegal() {
<span class="nc" id="L38">        return legal;</span>
    }
    
	/**
	 * Method to move the piece
	 * @param event the key w a s d in order to move the piece 
	 * @param selectedPiece 
	 * @param board
	 * @param initialPositions 
	 * @param legal
	 * @param moveHistory
	 * @param moves
	 * @return return an Engine object which is used to validate the move
	 */
    
    public static Engine movePiece(KeyEvent event, Rectangle selectedPiece, GridPane board, Map&lt;Rectangle, Integer[]&gt; initialPositions, boolean legal, Stack&lt;MoveInfo&gt; moveHistory, int moves) {
<span class="nc" id="L54">    	KeyCode keyCode = event.getCode();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">    	if (selectedPiece == null) {</span>
<span class="nc" id="L56">	    	return new Engine(false);</span>
	    }
<span class="nc" id="L58">        int rowChange = 0;</span>
<span class="nc" id="L59">        int columnChange = 0;</span>

<span class="nc bnc" id="L61" title="All 5 branches missed.">        switch (keyCode) {</span>
            case W:
<span class="nc" id="L63">                rowChange = -1;</span>
<span class="nc" id="L64">                break;</span>
            case S:
<span class="nc" id="L66">                rowChange = 1;</span>
<span class="nc" id="L67">                break;</span>
            case A:
<span class="nc" id="L69">                columnChange = -1;</span>
<span class="nc" id="L70">                break;</span>
            case D:
<span class="nc" id="L72">                columnChange = 1;</span>
<span class="nc" id="L73">                break;</span>
            default:
<span class="nc" id="L75">                return new Engine(false); // Return a default value for unknown key events</span>
        }
        
        // save the old column and row index for the move history
<span class="nc" id="L79">	    int oldRowIndex = GridPane.getRowIndex(selectedPiece);</span>
<span class="nc" id="L80">	    int oldColumnIndex = GridPane.getColumnIndex(selectedPiece);</span>
	    
	    // Calculate new position
<span class="nc" id="L83">	    int rowIndex = GridPane.getRowIndex(selectedPiece);</span>
<span class="nc" id="L84">	    int columnIndex = GridPane.getColumnIndex(selectedPiece);</span>
<span class="nc" id="L85">	    int newRow = rowIndex + rowChange;</span>
<span class="nc" id="L86">	    int newColumn = columnIndex + columnChange;</span>
	    
<span class="nc" id="L88">	    boolean newPositionLegal = false;</span>
	    
	    // set the type of the selected piece in order to be able to control its movement conditions
<span class="nc" id="L91">	    int type=0;</span>
<span class="nc bnc" id="L92" title="All 4 branches missed.">	    if((selectedPiece.getWidth()==200) &amp;&amp; (selectedPiece.getHeight()==100)) {</span>
<span class="nc" id="L93">		    type=1;</span>
<span class="nc bnc" id="L94" title="All 4 branches missed.">	    }else if((selectedPiece.getWidth()==100) &amp;&amp; (selectedPiece.getHeight()==200)) {</span>
<span class="nc" id="L95">		    type=2;</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">	    }else if ((selectedPiece.getWidth()==200) &amp;&amp; (selectedPiece.getHeight()==200)) {</span>
<span class="nc" id="L97">		    type=3;</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">	    }else if((selectedPiece.getWidth()==100) &amp;&amp; (selectedPiece.getHeight()==100))  {</span>
<span class="nc" id="L99">		    type=4;</span>
	    }
	    // Check if the new position is within grid limits for the selected piece
<span class="nc bnc" id="L102" title="All 2 branches missed.">	    if (Support.isMoveWithinBounds(newRow, newColumn, type)) {</span>
	        // Check if the new position is not occupied by another piece
<span class="nc" id="L104">	        Node occupant = Support.getNodeAtPosition(board, newRow, newColumn);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">	        if (occupant == null) {</span>
	            // Check for overlap with other pieces
<span class="nc" id="L107">	            boolean overlap = Support.checkForOverlap(selectedPiece, newRow, newColumn, initialPositions);</span>
	            
<span class="nc bnc" id="L109" title="All 2 branches missed.">	            if (!overlap) {</span>
<span class="nc" id="L110">	                GridPane.setRowIndex(selectedPiece, newRow);</span>
<span class="nc" id="L111">	                GridPane.setColumnIndex(selectedPiece, newColumn);</span>
<span class="nc" id="L112">	                newPositionLegal = true;</span>
	            }
	        }
	    }
<span class="nc bnc" id="L116" title="All 2 branches missed.">	    if (newPositionLegal) {</span>
	    	
	        // Store the previous position before making the move
<span class="nc" id="L119">	        MoveInfo moveInfo = new MoveInfo(selectedPiece, oldRowIndex, oldColumnIndex);</span>
<span class="nc" id="L120">	        moveHistory.push(moveInfo);</span>
	    	
	        // Update UI
<span class="nc" id="L123">	        legal = newPositionLegal;</span>
<span class="nc" id="L124">	        return new Engine(legal);</span>
	    }
<span class="nc" id="L126">	    return new Engine(false); // Return a default value if the move is not legal</span>
	}
    
    /**
     * Method to reset the board
     * @param initialPositions
     */
    
    public static void reset (Map&lt;Rectangle, Integer[]&gt; initialPositions) {
<span class="nc bnc" id="L135" title="All 2 branches missed.">		for (Map.Entry&lt;Rectangle, Integer[]&gt; entry : initialPositions.entrySet()) {</span>
<span class="nc" id="L136">	        Rectangle rectangle = entry.getKey();</span>
<span class="nc" id="L137">	        Integer[] initialPosition = entry.getValue();</span>
<span class="nc" id="L138">	        GridPane.setRowIndex(rectangle, initialPosition[0]);</span>
<span class="nc" id="L139">	        GridPane.setColumnIndex(rectangle, initialPosition[1]);</span>

	    }
<span class="nc" id="L142">	}</span>
    
    /**
     * Method to roll back the last move done
     * @param moveHistory
     */
    
	public static void undo(Stack&lt;MoveInfo&gt; moveHistory) {
<span class="nc bnc" id="L150" title="All 2 branches missed.">	    if (!moveHistory.isEmpty()) {</span>
<span class="nc" id="L151">	        MoveInfo lastMove = moveHistory.pop();</span>
<span class="nc" id="L152">	        Rectangle piece = lastMove.piece;</span>
<span class="nc" id="L153">	        int oldRow = lastMove.oldRow;</span>
<span class="nc" id="L154">	        int oldColumn = lastMove.oldColumn;</span>

<span class="nc" id="L156">	        GridPane.setRowIndex(piece, oldRow);</span>
<span class="nc" id="L157">	        GridPane.setColumnIndex(piece, oldColumn);</span>
	    }
<span class="nc" id="L159">	}</span>
    
	/**
	 * Method to save the board state in a json file called &quot;board_state.json&quot; saved in &quot;
	 * @param board
	 * @param currentPositions
	 * @param numberOfMoves 
	 */
	
	public static void save(GridPane board, Map&lt;Rectangle, Integer[]&gt; currentPositions, int numberOfMoves) {
	    try {
	    	// construction of the save file 
<span class="nc" id="L171">	        JsonObject saveFile = new JsonObject();</span>
<span class="nc" id="L172">	        saveFile.addProperty(&quot;numberOfMoves&quot;, numberOfMoves);</span>
<span class="nc" id="L173">	        JsonObject initialPositionsObject = new JsonObject();</span>
	       
	        
<span class="nc bnc" id="L176" title="All 2 branches missed.">	        for (Map.Entry&lt;Rectangle, Integer[]&gt; entry : currentPositions.entrySet()) {</span>
<span class="nc" id="L177">	            Rectangle piece = entry.getKey();</span>
<span class="nc" id="L178">	            Integer[] position = entry.getValue();</span>
	            
	            // Ensure the key is not null before adding to the JsonObject
<span class="nc" id="L181">	            String pieceId = piece.getId();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">	            if (pieceId != null) {</span>
<span class="nc" id="L183">	                JsonObject pieceInfo = new JsonObject();</span>
<span class="nc" id="L184">	                pieceInfo.addProperty(&quot;y&quot;, position[0]);</span>
<span class="nc" id="L185">	                pieceInfo.addProperty(&quot;x&quot;, position[1]);</span>
<span class="nc" id="L186">	                initialPositionsObject.add(pieceId, pieceInfo);</span>
	            }
	        }
<span class="nc" id="L189">	        saveFile.add(&quot;initialPositions&quot;, initialPositionsObject);</span>

<span class="nc" id="L191">	        Gson gson = new GsonBuilder().setPrettyPrinting().create();</span>

	        // Define the file name and extension
<span class="nc" id="L194">	        String currentDirectory = System.getProperty(&quot;user.dir&quot;);</span>
<span class="nc" id="L195">	        String directoryPath = currentDirectory + File.separator + &quot;src&quot; + File.separator + &quot;Save-Config&quot; + File.separator;</span>
<span class="nc" id="L196">	        String fileName = directoryPath+&quot;board_state.json&quot;;</span>

<span class="nc" id="L198">	        FileWriter writer = new FileWriter(fileName);</span>
<span class="nc" id="L199">	        gson.toJson(saveFile, writer);</span>
<span class="nc" id="L200">	        writer.close();</span>
	        

<span class="nc" id="L203">	    } catch (IOException e) {</span>
<span class="nc" id="L204">	        e.printStackTrace();</span>
	    }
<span class="nc" id="L206">	}</span>
	

	public static int load(String jsonFilePath, GridPane board, Map&lt;Rectangle, Integer[]&gt; initialPositions ) {
<span class="nc" id="L210">		int numberOfMoves = 0; // Initialize with a default value</span>
		try {
<span class="nc" id="L212">	        Gson gson = new Gson();</span>
<span class="nc" id="L213">	        FileReader reader = new FileReader(jsonFilePath);</span>
<span class="nc" id="L214">	        JsonObject jsonObject = gson.fromJson(reader, JsonObject.class);</span>
<span class="nc" id="L215">	        JsonElement numberOfMovesElement = jsonObject.get(&quot;numberOfMoves&quot;);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">	        if (numberOfMovesElement != null) {</span>
<span class="nc" id="L217">	            numberOfMoves = numberOfMovesElement.getAsInt();</span>
	        }
	        
<span class="nc bnc" id="L220" title="All 2 branches missed.">	        for (Map.Entry&lt;String, JsonElement&gt; entry : jsonObject.getAsJsonObject(&quot;initialPositions&quot;).entrySet()) {</span>
<span class="nc" id="L221">	            String pieceId = entry.getKey();</span>
<span class="nc" id="L222">	            JsonObject pieceInfo = entry.getValue().getAsJsonObject();</span>
<span class="nc" id="L223">	            Rectangle piece = null;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">	            for (Map.Entry&lt;Rectangle, Integer[]&gt; positionEntry : initialPositions.entrySet()) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">	                if (positionEntry.getKey().getId().equals(pieceId)) {</span>
<span class="nc" id="L226">	                    piece = positionEntry.getKey();</span>
<span class="nc" id="L227">	                    break;</span>
	                }
	            }

<span class="nc bnc" id="L231" title="All 2 branches missed.">	            if (piece != null) {</span>
	                int newRow, newColumn;

<span class="nc" id="L234">	                JsonElement rowElement = pieceInfo.get(&quot;y&quot;);</span>
<span class="nc" id="L235">	                JsonElement columnElement = pieceInfo.get(&quot;x&quot;);</span>

<span class="nc bnc" id="L237" title="All 4 branches missed.">	                if (rowElement != null &amp;&amp; columnElement != null) {</span>
<span class="nc" id="L238">	                    newRow = rowElement.getAsInt();</span>
<span class="nc" id="L239">	                    newColumn = columnElement.getAsInt();</span>
<span class="nc" id="L240">	                } else {</span>
<span class="nc" id="L241">	                    newRow = pieceInfo.get(&quot;y&quot;).getAsInt();</span>
<span class="nc" id="L242">	                    newColumn = pieceInfo.get(&quot;x&quot;).getAsInt();</span>
	                }

	                // Update the position of the piece on the board
<span class="nc" id="L246">	                GridPane.setRowIndex(piece, newRow);</span>
<span class="nc" id="L247">	                GridPane.setColumnIndex(piece, newColumn);</span>
	                
	                // Update the initialPositions map
<span class="nc" id="L250">	                initialPositions.put(piece, new Integer[]{newRow, newColumn});</span>
	            }
	        }

<span class="nc" id="L254">	    } catch (IOException e) {</span>
<span class="nc" id="L255">	    	Alert err=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L256">	    	err.setTitle(&quot;Error&quot;);</span>
<span class="nc" id="L257">	    	err.setHeaderText(&quot;Error&quot;);</span>
<span class="nc" id="L258">			err.setContentText(&quot;No saved data found&quot;);</span>
<span class="nc" id="L259">			err.showAndWait();</span>
	    }
<span class="nc" id="L261">		return numberOfMoves;</span>
	}

	
	public static void loadConfiguration(String jsonFilePath, GridPane board, Map&lt;Rectangle, Integer[]&gt; initialPositions) {
	    try {
<span class="nc" id="L267">	        Gson gson = new Gson();</span>
<span class="nc" id="L268">	        FileReader reader = new FileReader(jsonFilePath);</span>
<span class="nc" id="L269">	        JsonObject jsonObject = gson.fromJson(reader, JsonObject.class);</span>

<span class="nc bnc" id="L271" title="All 2 branches missed.">	        for (Map.Entry&lt;String, JsonElement&gt; entry : jsonObject.getAsJsonObject(&quot;initialPositions&quot;).entrySet()) {</span>
<span class="nc" id="L272">	            String pieceId = entry.getKey();</span>
<span class="nc" id="L273">	            JsonObject pieceInfo = entry.getValue().getAsJsonObject();</span>

<span class="nc" id="L275">	            Rectangle piece = null;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">	            for (Map.Entry&lt;Rectangle, Integer[]&gt; positionEntry : initialPositions.entrySet()) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">	                if (positionEntry.getKey().getId().equals(pieceId)) {</span>
<span class="nc" id="L278">	                    piece = positionEntry.getKey();</span>
<span class="nc" id="L279">	                    break;</span>
	                }
	            }

<span class="nc bnc" id="L283" title="All 2 branches missed.">	            if (piece != null) {</span>
	                int newRow, newColumn;

<span class="nc" id="L286">	                JsonElement rowElement = pieceInfo.get(&quot;row&quot;);</span>
<span class="nc" id="L287">	                JsonElement columnElement = pieceInfo.get(&quot;column&quot;);</span>

<span class="nc bnc" id="L289" title="All 4 branches missed.">	                if (rowElement != null &amp;&amp; columnElement != null) {</span>
<span class="nc" id="L290">	                    newRow = rowElement.getAsInt();</span>
<span class="nc" id="L291">	                    newColumn = columnElement.getAsInt();</span>
<span class="nc" id="L292">	                } else {</span>
<span class="nc" id="L293">	                    newRow = pieceInfo.get(&quot;y&quot;).getAsInt();</span>
<span class="nc" id="L294">	                    newColumn = pieceInfo.get(&quot;x&quot;).getAsInt();</span>
	                }

	                // Update the position of the piece on the board
<span class="nc" id="L298">	                GridPane.setRowIndex(piece, newRow);</span>
<span class="nc" id="L299">	                GridPane.setColumnIndex(piece, newColumn);</span>
	                
	                // Update the initialPositions map
<span class="nc" id="L302">	                initialPositions.put(piece, new Integer[]{newRow, newColumn});</span>

	            }
	        }

<span class="nc" id="L307">	    } catch (IOException e) {</span>
<span class="nc" id="L308">	    	Alert err=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L309">	    	err.setTitle(&quot;Error&quot;);</span>
<span class="nc" id="L310">	    	err.setHeaderText(&quot;Error&quot;);</span>
<span class="nc" id="L311">			err.setContentText(&quot;No configuration data found&quot;);</span>
<span class="nc" id="L312">			err.showAndWait();</span>
	    }
<span class="nc" id="L314">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span>SupportTest (3) (4 set 2023 18:50:32)</div></body></html>
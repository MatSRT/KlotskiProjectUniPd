<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>Controller.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">SupportTest (3) (4 set 2023 18:50:32)</a> &gt; <a href="../../index.html" class="el_group">KlotskiTest</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">application</a> &gt; <span class="el_source">Controller.java</span></div><h1>Controller.java</h1><pre class="source lang-java linenums">package application;

import java.net.URL;
import java.util.HashMap;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.Stack;

import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.Alert;
import javafx.scene.control.Alert.AlertType;
import javafx.scene.control.ButtonType;
import javafx.scene.control.Label;
import javafx.scene.input.KeyEvent;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.GridPane;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import javafx.stage.Stage;



/**
 *  Controller class to interrogate the javaFX GUI
 *	Implements move counter, a map to store the initial positions and a stack used to track moves history
 *	Rectangle objects are used since there is no need to extend it to describe the pieces of the puzzle
 */

<span class="nc" id="L33">public class Controller implements Initializable {</span>
	
<span class="nc" id="L35">	private int moves=0; // Move counter. Default value: 0</span>
<span class="nc" id="L36">	private int loadedMoves=0; // Move Counter loaded from save file</span>
	private boolean legal; // Boolean value used to check if the move is either valid (legal) or not
	private boolean isLoad; //Boolean value used to update move counter if reset after load
    private Stage stage;
    
<span class="nc" id="L41">    private Map&lt;Rectangle, Integer[]&gt; initialPositions = new HashMap&lt;&gt;(); // Map to store initial positions</span>
<span class="nc" id="L42">    private Map&lt;Rectangle, Integer[]&gt; currentPositions = new HashMap&lt;&gt;(); // Map to store current positions of every piece in order to be able to save/load the board</span>
<span class="nc" id="L43">    private Stack&lt;MoveInfo&gt; moveHistory = new Stack&lt;&gt;(); // Stack to store moves history</span>
    private Engine result; // Engine object used to get the result of the movement action of a piece

	
    private Rectangle selectedPiece; // Rectangle object to identify the piece selected with mouse
	public Rectangle[] pieces; //Array used to handle all the Rectangle objects on the board
	
    /**
     * Elements injected from FXML file.
     */
	
	@FXML
	public AnchorPane anchorPane;
    @FXML
    private GridPane board;
    
	@FXML
	private Rectangle piece1;
	@FXML
	private Rectangle piece2;
	@FXML
	private Rectangle piece3;
	@FXML
	private Rectangle piece4;
	@FXML
	private Rectangle piece5;
	@FXML
	private Rectangle piece6;
	@FXML
	private Rectangle piece7;
	@FXML
	private Rectangle piece8;
	@FXML
	private Rectangle piece9;
	@FXML
	private Rectangle piece10;
	
	@FXML
	private Label MoveCounter;
	
	
	
	/**
	 * Method to initialize the controller
	 * Add the EventHandler to the anchor pane and save the initial position for all the pieces in order to be able to reset the board
	 */
	
    @Override
    public void initialize(URL url, ResourceBundle resourceBundle) {
<span class="nc" id="L92">        anchorPane.addEventHandler(KeyEvent.KEY_PRESSED, keyEventHandler);</span>
        
<span class="nc" id="L94">        pieces = new Rectangle[]{piece1, piece2, piece3, piece4,piece5,piece6,piece7,piece8,piece9,piece10};</span>
        
        // Store initial positions for pieces
<span class="nc bnc" id="L97" title="All 2 branches missed.">        for (Rectangle piece : pieces) {</span>
<span class="nc" id="L98">        	initialPositions.put(piece, new Integer[]{GridPane.getRowIndex(piece), GridPane.getColumnIndex(piece)});</span>
<span class="nc" id="L99">        	Integer[] initialPosition = initialPositions.get(piece);</span>
<span class="nc" id="L100">            currentPositions.put(piece, initialPosition.clone());</span>
        }
        // Attach event handlers to the pieces
<span class="nc bnc" id="L103" title="All 2 branches missed.">        for (Rectangle piece : pieces) {</span>
<span class="nc" id="L104">        	piece.setOnMouseClicked(this::pieceClicked);</span>
        }
<span class="nc" id="L106">    }</span>
    
    public void setStage(Stage stage) {
<span class="nc" id="L109">        this.stage = stage;</span>
<span class="nc" id="L110">    }</span>
    
    /**
     * Method to highlight the piece selected on the board with the mouse
     * @param event: register the click of the mouse on a piece
     */
    private void pieceClicked(MouseEvent event) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">    	if (selectedPiece != null) {</span>
<span class="nc" id="L118">            selectedPiece.setStroke(Color.BLACK); // Reset the stroke color of previously selected piece</span>
            
        }

<span class="nc" id="L122">        selectedPiece = (Rectangle) event.getSource();</span>
<span class="nc" id="L123">        selectedPiece.setStroke(Color.YELLOW); // Highlight the selected piece</span>
<span class="nc" id="L124">    }</span>
    
    /**
     * Lambda expression to move the selected piece calling the Engine method &quot;move&quot;
     * If the move is legal (no out of bound and no overlap with other pieces)
     * the selected piece is moved and currentPositions is updated in order to be able to save the game
     * moveHistory is updated in order to be able to undo the move
     */
    
<span class="nc" id="L133">    public EventHandler&lt;KeyEvent&gt; keyEventHandler = event -&gt; {</span>
<span class="nc" id="L134">        result = Engine.movePiece(event, selectedPiece, board, initialPositions, legal, moveHistory, moves);</span>
<span class="nc" id="L135">        legal = result.isLegal();</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (legal) {</span>
<span class="nc" id="L138">            moves++;</span>
<span class="nc" id="L139">            MoveCounter.setText(&quot;Moves: &quot; + moves);</span>
            
            //store the position of every piece
<span class="nc bnc" id="L142" title="All 2 branches missed.">            for (Rectangle piece : pieces) {</span>
<span class="nc" id="L143">                int pieceRow = GridPane.getRowIndex(piece);</span>
<span class="nc" id="L144">                int pieceColumn = GridPane.getColumnIndex(piece);</span>
<span class="nc" id="L145">                currentPositions.put(piece, new Integer[]{pieceRow, pieceColumn});</span>
            }
        }
        
        //checking if the player won the game
<span class="nc bnc" id="L150" title="All 4 branches missed.">        if (selectedPiece.getWidth() == 200 &amp;&amp; selectedPiece.getHeight() == 200) { </span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if(Support.isWin(board, selectedPiece)) { </span>
<span class="nc" id="L152">            	Alert win=new Alert(AlertType.CONFIRMATION);</span>
<span class="nc" id="L153">            	win.setTitle(&quot;WIN&quot;);</span>
<span class="nc" id="L154">            	win.setHeaderText(&quot;You won, game now will restart&quot;);</span>
<span class="nc" id="L155">            	win.setContentText(&quot;Do you want to play another game?&quot;);</span>
<span class="nc" id="L156">            	win.getButtonTypes().setAll(ButtonType.YES, ButtonType.NO);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            	if(win.showAndWait().get()==ButtonType.YES){</span>
<span class="nc" id="L158">            		Engine.reset(initialPositions);</span>
<span class="nc" id="L159">            		moves=0;</span>
<span class="nc" id="L160">            		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L161">            	}else {</span>
<span class="nc" id="L162">            		Alert ex=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L163">            		ex.setHeaderText(&quot;Exit&quot;);</span>
<span class="nc" id="L164">            		ex.setContentText(&quot;Game will now exit. Thank you for playing&quot;);</span>
<span class="nc" id="L165">            		ex.showAndWait();</span>
<span class="nc" id="L166">            		stage.close();</span>
            	}
            	
            }
        }
<span class="nc" id="L171">    };</span>
    
    /**
     * Method to call the reset of the board
     * reset the move counter to zero
     * @param e ActionEvent when button &quot;Reset&quot; is pressed
     */
    
    public void reset(ActionEvent e) {
<span class="nc" id="L180">    	Engine.reset(initialPositions);</span>
<span class="nc" id="L181">    	moveHistory.clear();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">    	if(isLoad==true) {</span>
<span class="nc" id="L183">    		moves=loadedMoves;</span>
<span class="nc" id="L184">    	}else {</span>
<span class="nc" id="L185">    		moves=0;</span>
    	}
<span class="nc" id="L187">		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L188">	}</span>
    
    /**
     * Method to handle the interaction between the undo button and the undo method in Engine class
     * move counter get decremented by one
     * if there is no move to undo the controller will show an alert on screen
     * @param e ActionEvent when button &quot;undo&quot; is pressed
     */
	
	public void undo(ActionEvent e) {

<span class="nc bnc" id="L199" title="All 4 branches missed.">		if(!moveHistory.isEmpty()&amp;&amp;moves&gt;loadedMoves) {</span>
<span class="nc" id="L200">			Engine.undo(moveHistory);</span>
<span class="nc" id="L201">			moves--;</span>
<span class="nc" id="L202">			MoveCounter.setText(&quot;Moves: &quot; + moves);</span>
<span class="nc" id="L203">		}else {</span>
<span class="nc" id="L204">			Alert warning=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L205">			warning.setTitle(&quot;Warning&quot;);</span>
<span class="nc" id="L206">			warning.setHeaderText(&quot;Warning&quot;);</span>
<span class="nc" id="L207">			warning.setContentText(&quot;There is no move to undo&quot;);</span>
<span class="nc" id="L208">			warning.showAndWait();</span>
		}
<span class="nc" id="L210">	}</span>

	public void nbm(ActionEvent e) {
<span class="nc" id="L213">		System.out.println(&quot;NBM&quot;);</span>
<span class="nc" id="L214">		BoardForSolver.Traduction(board, currentPositions);</span>
<span class="nc" id="L215">		moves+=1;</span>
<span class="nc" id="L216">		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L217">	}</span>
	
	/**
	 * Method to handle the interaction between the save button and the save method of Engine class
	 * @param e ActionEvent when button &quot;save&quot; is pressed
	 */
	
	public void save(ActionEvent e) {
<span class="nc" id="L225">		Engine.save(board, currentPositions, moves);</span>
        // Alert to signal to the player that the game has been saved
<span class="nc" id="L227">		Alert saved=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L228">		saved.setTitle(&quot;Saving&quot;);</span>
<span class="nc" id="L229">		saved.setHeaderText(&quot;Saving&quot;);</span>
<span class="nc" id="L230">		saved.setContentText(&quot;Game saved in file board_state.json&quot;);</span>
<span class="nc" id="L231">		saved.showAndWait();</span>
<span class="nc" id="L232">	}</span>
	
	/**
	 * Method to handle the interaction between the load button and the load method of Engine class
	 * move counter is set based on the move counter saved on the save file
	 * @param e ActionEvent when button &quot;load&quot; is pressed
	 */
	
	public void load(ActionEvent e) {
<span class="nc" id="L241">		isLoad=true;</span>
<span class="nc" id="L242">		moves=Engine.load(&quot;src/Save-Config/board_state.json&quot;, board, initialPositions);</span>
<span class="nc" id="L243">		loadedMoves=moves;</span>
<span class="nc" id="L244">		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L245">	}</span>
	
	/**
	 * Method to exit the game with &quot;exit&quot; button
	 * A pop up alert is shown to inform the player that the game will close
	 * @param e ActionEvent when button &quot;exit&quot; is pressed
	 */
	
	public void exit(ActionEvent e) {
<span class="nc" id="L254">		Alert ex=new Alert(AlertType.CONFIRMATION);</span>
<span class="nc" id="L255">		ex.setHeaderText(&quot;Exit&quot;);</span>
<span class="nc" id="L256">		ex.setContentText(&quot;Are you sure you want to exit?&quot;);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">		if(ex.showAndWait().get()==ButtonType.OK) {</span>
<span class="nc" id="L258">			stage.close();</span>
		}
<span class="nc" id="L260">	}</span>
	
	/**
	 * Method to handle the interaction between the config1 button and the loadConfiguration method of Engine class
	 * @param e ActionEvent when button &quot;1&quot; is pressed
	 */
	
	public void Config1(ActionEvent e) {
		
		//new game started
<span class="nc" id="L270">		moves=0;</span>
<span class="nc" id="L271">		isLoad=false;</span>
<span class="nc" id="L272">		loadedMoves=0;</span>
<span class="nc" id="L273">		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L274">		Engine.loadConfiguration(&quot;src/Save-Config/config1.json&quot;, board, initialPositions);</span>
<span class="nc" id="L275">		Alert config=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L276">		config.setTitle(&quot;Loading Configuration&quot;);</span>
<span class="nc" id="L277">		config.setHeaderText(&quot;Configuration loaded&quot;);</span>
<span class="nc" id="L278">		config.setContentText(&quot;Configuration loaded from file, good game&quot;);</span>
<span class="nc" id="L279">		config.showAndWait();</span>
<span class="nc" id="L280">	}</span>
	
	/**
	 * Method to handle the interaction between the config2 button and the loadConfiguration method of Engine class
	 * @param e ActionEvent when button &quot;2&quot; is pressed
	 */
	public void Config2(ActionEvent e) {
		
		//new game started
<span class="nc" id="L289">		moves=0;</span>
<span class="nc" id="L290">		isLoad=false;</span>
<span class="nc" id="L291">		loadedMoves=0;</span>
<span class="nc" id="L292">		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L293">		Engine.loadConfiguration(&quot;src/Save-Config/config2.json&quot;, board, initialPositions);</span>
<span class="nc" id="L294">		Alert config=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L295">		config.setTitle(&quot;Loading Configuration&quot;);</span>
<span class="nc" id="L296">		config.setHeaderText(&quot;Configuration loaded&quot;);</span>
<span class="nc" id="L297">		config.setContentText(&quot;Configuration loaded from file, good game&quot;);</span>
<span class="nc" id="L298">		config.showAndWait();</span>
<span class="nc" id="L299">	}</span>
	
	/**
	 * Method to handle the interaction between the config3 button and the loadConfiguration method of Engine class
	 * @param e ActionEvent when button &quot;3&quot; is pressed
	 */
	
	public void Config3(ActionEvent e) {
		
		//new game started
<span class="nc" id="L309">		moves=0;</span>
<span class="nc" id="L310">		isLoad=false;</span>
<span class="nc" id="L311">		loadedMoves=0;</span>
<span class="nc" id="L312">		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L313">		Engine.loadConfiguration(&quot;src/Save-Config/config3.json&quot;, board, initialPositions);</span>
<span class="nc" id="L314">		Alert config=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L315">		config.setTitle(&quot;Loading Configuration&quot;);</span>
<span class="nc" id="L316">		config.setHeaderText(&quot;Configuration loaded&quot;);</span>
<span class="nc" id="L317">		config.setContentText(&quot;Configuration loaded from file, good game&quot;);</span>
<span class="nc" id="L318">		config.showAndWait();</span>
<span class="nc" id="L319">	}</span>
	
	/**
	 * Method to handle the interaction between the Default button and the loadConfiguration method of Engine class
	 * @param e ActionEvent when button &quot;Default&quot; is pressed
	 */
	
	public void Default(ActionEvent e) {
		
		//new game started
<span class="nc" id="L329">		moves=0;</span>
<span class="nc" id="L330">		isLoad=false;</span>
<span class="nc" id="L331">		loadedMoves=0;</span>
<span class="nc" id="L332">		MoveCounter.setText(&quot;Moves: &quot;+moves);</span>
<span class="nc" id="L333">		Engine.loadConfiguration(&quot;src/Save-Config/defConfig.json&quot;, board, initialPositions);</span>
<span class="nc" id="L334">		Alert config=new Alert(AlertType.INFORMATION);</span>
<span class="nc" id="L335">		config.setTitle(&quot;Loading Configuration&quot;);</span>
<span class="nc" id="L336">		config.setHeaderText(&quot;Configuration loaded&quot;);</span>
<span class="nc" id="L337">		config.setContentText(&quot;Configuration loaded from file, good game&quot;);</span>
<span class="nc" id="L338">		config.showAndWait();</span>
<span class="nc" id="L339">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span>SupportTest (3) (4 set 2023 18:50:32)</div></body></html>